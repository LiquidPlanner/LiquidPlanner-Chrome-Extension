<html>
<head>
<title>LiquidChrome Options</title>
<link rel="stylesheet" href="/style.css" type="text/css" charset="utf-8">
<script src='jquery-1.4.1.js'></script>
<script src='liquid_chrome.js'></script>
<script>

// Extracts data from each task's JSON data, and inserts it into the menu
function showTasks(tasks, status) {
  var url, html;
  var pending_tasks = $('#pending_tasks');
  var done_tasks = $('#done_tasks');
  var baseTemplate = $('#templates .task');
  
  $('#message').hide();
  
  for (var i = 0, task; task = tasks[i]; i++) {
    html = baseTemplate.clone();
    url = route(LiquidChrome.showTaskUrl, {task_id: task.id});
    
    html.attr({'href': url}).find('.name').text(task.name);
    
    if(task.is_done){
      done_tasks.append(html);
    } else {
      if(task.low_effort_remaining && task.high_effort_remaining){
        html.find('.estimate').text('estimate: ' + task.low_effort_remaining + '-' + task.high_effort_remaining);
      }
    
      if(task.promise_by){
        var date = task.promise_by.split("T")[0];
        html.find('.promise').text('due: ' + date);
      }
    
      if(task.alerts && task.alerts.length > 0){
        var severity = {'red': 2, 'yellow': 1, 'none': 0};
        var flag = task.alerts.reduce(function(prev, alert){ 
          var curr = alert.flag;
          return severity[prev] > severity[curr] ? prev : curr;
        }, 'none');
        html.addClass(flag+'_flag');
      }
      
      pending_tasks.append(html);
    }
  }
}

// Extracts data from each comment's JSON data, and inserts it into the menu
function showComments(comments, status) {
  var url, text, html, author, task;
  var chatter = $('#comments');
  var baseTemplate = $('#templates .comment');
    
  $('#message').hide();
  
  for (var i = 0, comment; comment = comments[i]; i++) {
    html = baseTemplate.clone();
    url = route(LiquidChrome.showTaskUrl, {task_id: comment.item_id});
    text = comment.plain_text.slice(0,72);
    if(text != comment.plain_text){
      text = text + '...';
    }
    
    html.attr({'href': url}).find('.text').text(text);
    author = LiquidChrome.members[comment.member_id] || LiquidChrome.members[0];
    task   = comment.treeitem;
    if(author){ 
      html.find('.author').text(author.user_name); 
    }
    
    if(task){
      html.find('.taskname').text('on: '+task.name); 
    }
    
    chatter.append(html);
  }
}

// Stores the members as a hash.  This is used to display the member's name in comments.
function storeMembers(members){
  LiquidChrome.members = {};
  for (var i = 0, member; member = members[i]; i++) {
    LiquidChrome.members[member.id] = member;
  }
}

function showConfigureRequest(){
  $('#message').removeClass('info').html( 
    $('<a class="menu_item" href="options.html" target="_liquid_chrome"></a>').text('Configure LiquidChrome') 
  );
}

function showLoginRequest(){
  var url = route(':host',{});
  $('#message').removeClass('info').html( 
    $('<a class="menu_item" href="'+url+'" target="_liquid_chrome"></a>').text('Please log into LiquidPlanner') 
  );
}


$(document).ready(function(){
  // Register a global Ajax error handler.
  $('#error').ajaxError(function(event, request, settings){
    console.log('error', event, request, settings);
    if( (request.readyState == 0 || request.readyState == 1) && settings.timeout){
      // This was probably a case of chrome getting a 401 response, but supressing the
      // HTTP Basic Auth dialog.  If so, direct the user to log into LiquidPlanner.
      // This is a chrome extension specific issue.
      showLoginRequest();
    } else {
      // Otherwise, report that there was an error 
      $(this).html("Could not load LiquidPlanner data").show();
    }
  });
  
  if(LiquidChrome.isConfigured()){
    if(LiquidChrome.defaults.pendingCount > 0){
      LiquidChrome.tasks({
        success:  showTasks,
        timeout:  3500, 
        data:{
          'filter':   ['owner_id = me', 'done is false'],
          'limit':    LiquidChrome.defaults.pendingCount,
          'order':    'earliest_start'
      }});
    }
    
    if(LiquidChrome.defaults.doneCount > 0){
      LiquidChrome.tasks({
        success:  showTasks, 
        timeout:  3500,
        data:{
          'filter':   ['owner_id = me', 'done is true'],
          'limit':    LiquidChrome.defaults.doneCount,
          'order':    'updated_at'
      }});
    }
    
    if(LiquidChrome.defaults.commentCount > 0){
      LiquidChrome.members({
        timeout:  3500,
        success: function(members){
          storeMembers(members);
          LiquidChrome.chatter({
            success:  showComments,
            error:    showError, 
            data:{
              'ignore_mine': LiquidChrome.defaults.ignoreMyComments,
              'for_me':      !LiquidChrome.defaults.showAllComments,
              'limit':       LiquidChrome.defaults.commentCount
          }});
        }
      });
    }    
  } else {
    showConfigureRequest();
  }
});
</script>

</head>
<body id='popup'>  
  <div id='message' class='info'>Loading...</div>
  <div id='error'   class='error'></div>
  
  <div class='section' id='comments'></div>  
  <div class='section' id='pending_tasks'></div>
  <div class='section' id='done_tasks'></div>
  
  
  <!-- The following are templates used to render Tasks and Comments -->
  <div style='display: none' id='templates'>
    <a class='task menu_item' target='_liquid_chrome' href=''>
      <span class='name'>{name}</span>
      <div  class='info'>
        <span class='estimate'></span>
        <span class='promise'></span>
      </div>
    </a>
    
    <a class='comment menu_item' target='_liquid_chrome' href=''>
      <div class='text'>{comment}</div>
      <div class='info'>
          <span class='author'></span> <span class='taskname'></span>
      </div>
    </a>
    
  </div>
</body>
</html>