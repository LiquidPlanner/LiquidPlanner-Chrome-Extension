<html>
<head>
<title>LiquidChrome Options</title>
<link rel="stylesheet" href="/style.css" type="text/css" charset="utf-8">
<script src='jquery-1.3.1.js'></script>
<script src='liquid_chrome.js'></script>
<script>
function showTasks(tasks, status) {
  var url, html;
  var pending_tasks = $('#pending_tasks');
  var done_tasks = $('#done_tasks');
  var baseTemplate = $('#templates .task');
  
  $('#popup .message').hide();
  
  for (var i = 0, task; task = tasks[i]; i++) {
    html = baseTemplate.clone();
    url = route(LiquidChrome.showTaskUrl, {task_id: task.id});
    
    html.attr({'href': url}).find('.name').text(task.name);
    
    if(task.low_effort_remaining && task.high_effort_remaining){
      html.find('.estimate').text('estimate: ' + task.low_effort_remaining + '-' + task.high_effort_remaining);
    }
    
    if(task.promise_by){
      var date = task.promise_by.split("T")[0];
      html.find('.promise').text('due: ' + date);
    }
    
    if(task.alerts && task.alerts.length > 0){
      var severity = {'red': 2, 'yellow': 1, 'none': 0};
      var flag = task.alerts.reduce(function(prev, alert){ 
        var curr = alert.flag;
        return severity[prev] > severity[curr] ? prev : curr;
      }, 'none');
      html.addClass(flag+'_flag');
    }
        
    (task.is_done ? done_tasks : pending_tasks).append(html);    
  }

  if(done_tasks.find('.task').size() > 0){
    done_tasks.show();
  }
}

function showConfigureRequest(){
  $('#popup .message').html( 
    $('<a class="menu_item" href="options.html" target="_liquid_chrome"></a>').text('Configure LiquidChrome') 
  );
}

$(document).ready(function(){
  if(LiquidChrome.isConfigured()){    
    LiquidChrome.tasks({
      success:  showTasks,
      error:    showError, 
      data:{
        'filter[]': ['owner_id = me', 'done is false'],
        'limit':    LiquidChrome.defaults.pendingCount,
        'order':    'earliest_start'
    }});
    
    LiquidChrome.tasks({
      success:  showTasks,
      error:    showError, 
      data:{
        'filter[]': ['owner_id = me', 'done is true'],
        'limit':    LiquidChrome.defaults.doneCount,
        'order':    'updated_at'
    }});
    
  } else {
    showConfigureRequest();
  }
});
</script>

</head>
<body id='popup'>
  <div id='nav'>
    <div class='tab' id='tasks_nav'>tasks</div>
    <div class='tab' id='chatter_nav'>chatter</div>
    <div style='clear:left;'></div>
  </div>
  
  <div class='message'>Loading...</div>
  
  <div id='tasks'>
    <div id='pending_tasks'></div>
    <div id='done_tasks' style='display: none;'></div>
  </div>
  
  <div id='chatter'>
  </div>
  
  <div style='display: none' id='templates'>
    <a class='task menu_item' target='_liquid_chrome' href=''>
      <span class='name'>{name}</span>
      <div  class='info'>
        <span class='estimate'></span>
        <span class='promise'></span>
      </div>
    </a>
  </div>
</body>
</html>